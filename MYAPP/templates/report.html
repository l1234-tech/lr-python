{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h3>Отчет 1 - Лабораторная работа №8</h3>
            </div>
            <div class="card-body">
                <h4 class="border-bottom pb-2">1. Цель работы</h4>
                <p>
                    Целью данной лабораторной работы было создание веб-приложения для отслеживания курсов валют
                    с использованием архитектуры MVC (Model-View-Controller). Основные задачи:
                </p>
                <ul>
                    <li>Реализация моделей данных (User, Currency, Author) с геттерами и сеттерами</li>
                    <li>Создание контроллеров для обработки HTTP-запросов</li>
                    <li>Разработка HTML-шаблонов с использованием Jinja2</li>
                    <li>Получать данные о курсах валют через функцию get_currencies и отображать их пользователям</li>
                    <li>Реализация системы подписок пользователей на валюты</li>
                    <li>Создание интерактивных графиков изменения курсов</li>
                    <li>Научиться создавать тесты для моделей и серверной логики (подробно описано в отчете 2)</li>
                </ul>

                <h4 class="border-bottom pb-2 mt-4">2. Описание предметной области</h4>
                <h5>Модели данных:</h5>
                <div class="row">
                    <div class="col-md-4">
                        <div class="card border-success mb-3">
                            <div class="card-header bg-success text-white">
                                <h6>User (Пользователь)</h6>
                            </div>
                            <div class="card-body">
                                <p><strong>Свойства:</strong></p>
                                <ul>
                                    <li>id - уникальный идентификатор</li>
                                    <li>name - имя пользователя</li>
                                    <li>subscriptions - список подписок на валюты</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-primary mb-3">
                            <div class="card-header bg-primary text-white">
                                <h6>Currency (Валюта)</h6>
                            </div>
                            <div class="card-body">
                                <p><strong>Свойства:</strong></p>
                                <ul>
                                    <li>name_curr - код валюты (USD, EUR и т.д.)</li>
                                    <li>currency_id - ID валюты в системе ЦБ</li>
                                    <li>name - полное название</li>
                                    <li>price - текущий курс</li>
                                    <li>previous - предыдущий курс</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-warning mb-3">
                            <div class="card-header bg-warning text-dark">
                                <h6>Author (Автор)</h6>
                            </div>
                            <div class="card-body">
                                <p><strong>Свойства:</strong></p>
                                <ul>
                                    <li>name - имя автора</li>
                                    <li>group - учебная группа</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <h5>Связи между моделями:</h5>
                <div class="text-center mb-4">
                    <div class="d-inline-block p-4 border rounded bg-light">
                        User (1) -- (n) Currency<br>
                        <small class="text-muted">Один пользователь может быть подписан на несколько валют</small>
                    </div>
                </div>

                <h4 class="border-bottom pb-2 mt-4">3. Структура проекта</h4>
                <pre class="bg-dark text-white p-3 rounded">
myapp/
├── models/                    # Модели данных
│   ├── __init__.py
│   ├── author.py             # Модель Author
│   ├── user.py               # Модель User
│   ├── currency.py           # Модель Currency
│   └── currency_parser.py    # Парсер API ЦБ
├── controllers/              # Контроллеры
│   ├── __init__.py
│   ├── databasecontroller.py # Работа с БД
│   ├── currencycontroller.py # Логика валют
│   ├── usercontroller.py     # Логика пользователей
│   └── pages.py             # Рендеринг страниц
├── templates/                # HTML шаблоны
│   ├── base.html            # Базовый шаблон
│   ├── index.html           # Главная страница
│   ├── author.html          # Об авторе
│   ├── users.html           # Пользователи
│   ├── user.html            # Конкретный пользователь
│   ├── currencies.html      # Валюты
│   ├── report.html          # Отчет 1
│   └── report2.html         # Отчет 2
├── myapp.py                 # Главный файл приложения
└── currencies.db            # База данных SQLite
                </pre>

                <h4 class="border-bottom pb-2 mt-4">4. Маршруты приложения</h4>
                <table class="table table-bordered">
                    <thead class="dark">
                        <tr>
                            <th>Маршрут</th>
                            <th>Описание</th>
                            <th>Шаблон</th>
                            <th>Метод</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>/</td>
                            <td>Главная страница с информацией об авторе и списком валют</td>
                            <td>index.html</td>
                            <td>GET</td>
                        </tr>
                        <tr>
                            <td>/author</td>
                            <td>Информация об авторе</td>
                            <td>author.html</td>
                            <td>GET</td>
                        </tr>
                        <tr>
                            <td>/users</td>
                            <td>Список пользователей</td>
                            <td>users.html</td>
                            <td>GET</td>
                        </tr>
                        <tr>
                            <td>/user?id=...</td>
                            <td>Просмотр одного пользователя</td>
                            <td>user.html</td>
                            <td>GET</td>
                        </tr>
                        <tr>
                            <td>/currencies</td>
                            <td>Список всех валют</td>
                            <td>currencies.html</td>
                            <td>GET</td>
                        </tr>
                        <tr>
                            <td>/user/subscription</td>
                            <td>Управление подписками</td>
                            <td>-</td>
                            <td>POST</td>
                        </tr>
                        <tr>
                            <td>/currencies/add</td>
                            <td>Добавление валюты</td>
                            <td>-</td>
                            <td>POST</td>
                        </tr>
                        <tr>
                            <td>/currencies/remove</td>
                            <td>Удаление валюты</td>
                            <td>-</td>
                            <td>POST</td>
                        </tr>
                        <tr>
                            <td>/currencies/update</td>
                            <td>Обновление курса валюты</td>
                            <td>-</td>
                            <td>POST</td>
                        </tr>
                        <tr>
                            <td>/report</td>
                            <td>Отчет 1</td>
                            <td>report.html</td>
                            <td>GET</td>
                        </tr>
                        <tr>
                            <td>/report2</td>
                            <td>Отчет 2</td>
                            <td>report2.html</td>
                            <td>GET</td>
                        </tr>
                    </tbody>
                </table>

                <h4 class="border-bottom pb-2 mt-4">5. Применение архитектуры MVC - разделение ответственности</h4>
                <div class="row">
                    <div class="col-md-4">
                        <div class="card border-success h-100">
                            <div class="card-header bg-success text-white">
                                <h5>Models</h5>
                            </div>
                            <div class="card-body">
                                <p><strong>Назначение:</strong></p>
                                <ul>
                                    <li>Только свойства сущностей</li>
                                    <li>Геттеры и сеттеры с валидацией</li>
                                    <li>Инкапсуляция данных</li>
                                    <li>Методы преобразования в словари</li>
                                </ul>
                                <p><strong>Пример реализации:</strong></p>
                                <pre><code>@property
def name(self):
    return self.__name

@name.setter
def name(self, value):
    if len(value) >= 1:
        self.__name = value
    else:
        raise ValueError('Имя не может быть пустым')</code></pre>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-primary h-100">
                            <div class="card-header bg-primary text-white">
                                <h5>Controllers</h5>
                            </div>
                            <div class="card-body">
                                <p><strong>Назначение:</strong></p>
                                <ul>
                                    <li>Обработка HTTP-запросов</li>
                                    <li>Взаимодействие с моделями</li>
                                    <li>Подготовка данных для представлений</li>
                                    <li>Маршрутизация</li>
                                </ul>
                                <p><strong>Отдельные модули:</strong></p>
                                <ul>
                                    <li>databasecontroller.py - работа с SQLite</li>
                                    <li>currencycontroller.py - бизнес-логика валют</li>
                                    <li>pages.py - рендеринг страниц через Jinja2</li>
                                    <li>usercontroller.py - работа с подписками</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-warning h-100">
                            <div class="card-header bg-warning text-dark">
                                <h5>Views</h5>
                            </div>
                            <div class="card-body">
                                <p><strong>Назначение:</strong></p>
                                <ul>
                                    <li>HTML шаблоны с Jinja2</li>
                                    <li>Наследование шаблонов</li>
                                    <li>Циклы и условия</li>
                                    <li>Интерактивные элементы</li>
                                </ul>
                                <p><strong>Инициализация Environment:</strong></p>
                                <pre><code>from jinja2 import Environment,
     PackageLoader, select_autoescape

env = Environment(
    loader=PackageLoader("myapp"),
    autoescape=select_autoescape()
)</code></pre>
                            </div>
                        </div>
                    </div>
                </div>

                <h4 class="border-bottom pb-2 mt-4">6. Интеграция с API ЦБ РФ</h4>
                <div class="card mb-3">
                    <div class="card-body">
                        <p><strong>Функция get_currencies для получения курсов:</strong></p>
                        <pre><code> def get_currencies(self, currency_codes: list):
        """Получает данные для списка валют"""
        from .currency import CurenciesList

        try:
            response = requests.get(self.api_url, timeout=10)
            response.raise_for_status()
            data = response.json()

            currencies = {}
            not_found = []

            if "Valute" in data:
                for code in currency_codes:
                    if code == 'RUB':
                        currency = CurenciesList(
                            name_curr='RUB',
                            currency_id='R00001',
                            name='Российский рубль',
                            value=1.0,
                            previous=1.0
                        )
                        currencies['RUB'] = currency
                    elif code in data["Valute"]:
                        currency_info = data["Valute"][code]
                        currency = CurenciesList(
                            name_curr=code,
                            currency_id=currency_info["ID"],
                            name=currency_info["Name"],
                            value=currency_info["Value"],
                            previous=currency_info["Previous"]
                        )
                        currencies[code] = currency
                    else:
                        not_found.append(code)

            for code in not_found:
                print(f"Валюта {code} не найдена в API, создаем фиктивные данные")
                currency = self._create_mock_currency(code)
                if currency:
                    currencies[code] = currency

            self._currencies_data.update(currencies)
            return currencies

        except Exception as e:
            print(f"Ошибка при запросе API для курсов: {e}")
            currencies = {}
            for code in currency_codes:
                currency = self._create_mock_currency(code)
                if currency:
                    currencies[code] = currency
            return currencies</code></pre>
                        <p class="mt-3">
                            <strong>Особенности интеграции:</strong>
                        </p>
                        <ul>
                            <li>Использование requests для HTTP-запросов</li>
                            <li>Обработка исключений при ошибках сети</li>
                            <li>Mocking (подроднее в отчете 2)</li>
                            <li>Обновление курсов при каждом запросе /currencies или по кнопке</li>
                        </ul>
                    </div>
                </div>

                <h4 class="border-bottom pb-2 mt-4">7. Выводы</h4>
                <div class="card border-info">
                    <div class="card-header bg-info text-white">
                        <h5>Итоги реализации</h5>
                    </div>
                    <div class="card-body">
                        <h6>Возникшие проблемы и их решение:</h6>
                        <ul>
                            <li><strong>Проблема:</strong> Неправильная работа с методами длины в шаблонах Jinja2
                                <br><strong>Решение:</strong> Замена <code>.length</code> на <code>|length</code> и использование <code>len()</code> в Python коде</li>
                            <li><strong>Проблема:</strong> Ошибки при обработке POST-запросов с пустыми данными
                                <br><strong>Решение:</strong> Добавление проверок на наличие и корректность параметров</li>
                            <li><strong>Проблема:</strong> Проблемы с отображением графиков при отсутствии данных
                                <br><strong>Решение:</strong> Реализация генерации фиктивных данных для отладки</li>
                        </ul>

                        <h6 class="mt-4">Применение принципов MVC:</h6>
                        <ul>
                            <li>Успешно реализовано разделение ответственности между компонентами</li>
                            <li>Контроллеры обрабатывают запросы и управляют потоком данных</li>
                            <li>Представления отвечают только за отображение</li>
                            <li>Реализовано разделение ответственности (MVC)</li>
                        </ul>

                        <h6 class="mt-4">Полученные знания:</h6>
                        <ul>
                            <li>Работа со стандартным HTTPServer и BaseHTTPRequestHandler</li>
                            <li>Использование Jinja2 для шаблонизации HTML</li>
                            <li>Интеграция с внешними API (ЦБ РФ)</li>
                            <li>Создание интерактивных графиков с Plotly.js</li>
                            <li>Работа с SQLite базой данных</li>
                            <li>Реализация системы подписок пользователей</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="card-footer text-center">
                <a href="/" class="btn btn-primary">
                    На главную
                </a>
                <a href="/report2" class="btn btn-secondary">
                    К отчету 2
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}
