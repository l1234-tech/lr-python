<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Отчёт по лабораторной работе №7</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            padding: 30px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #3498db;
        }

        h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #7f8c8d;
            font-size: 1.2em;
        }

        h2 {
            color: #3498db;
            margin: 25px 0 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #ecf0f1;
        }

        h3 {
            color: #2c3e50;
            margin: 20px 0 10px;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .code-block {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.95em;
            line-height: 1.4;
        }

        .code-block pre {
            white-space: pre-wrap;
        }

        .test-results {
            background-color: #e8f4f8;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 4px solid #2ecc71;
        }

        .test-results.failed {
            background-color: #fdeaea;
            border-left-color: #e74c3c;
        }

        .logs {
            background-color: #f4f4f4;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
        }

        .conclusion {
            background-color: #e8f6f3;
            padding: 20px;
            border-radius: 5px;
            margin-top: 30px;
            border-left: 4px solid #1abc9c;
        }

        ul {
            padding-left: 20px;
            margin: 10px 0;
        }

        li {
            margin-bottom: 8px;
        }

        .highlight {
            background-color: #fff9e6;
            padding: 3px 6px;
            border-radius: 3px;
            font-weight: bold;
        }

        .success {
            color: #27ae60;
            font-weight: bold;
        }

        .error {
            color: #c0392b;
            font-weight: bold;
        }

        footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ecf0f1;
            color: #7f8c8d;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            h1 {
                font-size: 2em;
            }

            .code-block {
                font-size: 0.85em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Отчёт по лабораторной работе №7</h1>
        </header>

        <div class="section">
            <h2>1. Исходный код декоратора с параметрами</h2>
            <div class="code-block">
<pre>def logger(func = None, *, handle = sys.stdout):
    """
    Декоратор для логирования вызовов функций и их результатов.
    Параметры:
    func : декорируемая функция. Если None, возвращает частично применённый декоратор.
    handle : ключевой параметр
    Объект для логирования может быть:
    - logging.Logger: логирование через методы info(), error()
    - Объект с методом write() (sys.stdout, io.StringIO)
    По умолчанию sys.stdout.
    Возвращает: callable
    Декорированная функция с логированием.
    """

    if func is None:
        return lambda f: logger(f, handle=handle)

    @functools.wraps(func)
    def inner(*args, **kwargs):
        func_name = func.__name__

        try:
            result = func(*args, **kwargs)

            success_message = f"Логгер отработал успешно '{func_name}'"

            if isinstance(handle, logging.Logger):
                handle.info(success_message)
            else:
                handle.write(f"INFO: {success_message}\n")

            return result

        except Exception as e:
            error_message = f"Ошибка в '{func_name}': {type(e).__name__}: {str(e)}"

            if isinstance(handle, logging.Logger):
                handle.error(error_message)
            else:
                handle.write(f"ERROR: {error_message}\n")
            raise

    return inner</pre>
            </div>
            <p><span class="highlight">Особенности реализации:</span></p>
            <ul>
                <li>Поддерживает три типа обработчиков: <span class="highlight">sys.stdout</span>, <span class="highlight">io.StringIO</span>, <span class="highlight">logging.Logger</span></li>
                <li>Может использоваться как <span class="highlight">@logger</span>,так и <span class="highlight">@logger(handle=...)</span></li>
                <li>Сохраняет сигнатуру функции с помощью <span class="highlight">functools.wraps</span></li>
            </ul>
        </div>

        <div class="section">
            <h2>2. Исходный код get_currencies (без логирования)</h2>
            <div class="code-block">
<pre>def get_currencies(currency_codes,
                   url: str = 'https://www.cbr-xml-daily.ru/daily_json.js'):
    """
    Получает текущие курсы валют с API Центрального Банка России.

    Параметры:
    currency_codes: список кодов валют (например, ['USD', 'EUR', 'GBP']).
    url: URL API Центрального Банка.

    Возвращает:
        Словарь, где ключи - коды валют, значения - курсы валют к рублю.

    Исключения:
    ConnectionError - если API недоступен или произошла ошибка сети.
    ValueError - если полученные данные не являются корректным JSON.
    KeyError - если в ответе API отсутствует ключ 'Valute' или валюта.
    TypeError - если курс валюты имеет неверный тип.
    """

    try:
        response = requests.get(url, timeout=10)
        response.raise_for_status()
    except requests.exceptions.RequestException as e:
        raise ConnectionError(f"Ошибка подключения к API: {str(e)}") from e

    try:
        data = response.json()
    except ValueError as e:
        raise ValueError(f"Ошибка парсинга JSON: {str(e)}") from e

    if "Valute" not in data:
        raise KeyError("В ответе API отсутствует ключ 'Valute'")

    currencies = {}

    for code in currency_codes:
        if code not in data["Valute"]:
            raise KeyError(f"Валюта с кодом '{code}' отсутствует в данных API")

        currency_data = data["Valute"][code]

        if not isinstance(currency_data.get("Value"), (int, float)):
            raise TypeError(f"Курс валюты '{code}' имеет неверный тип: {type(currency_data.get('Value'))}")

        currencies[code] = currency_data["Value"]

    return currencies</pre>
            </div>
            <p><span class="highlight">Ключевые моменты:</span></p>
            <ul>
                <li>Содержит только бизнес-логику, без логирования</li>
                <li>Выбрасывает соответствующие исключения при ошибках (содержит простые exceptions)</li>
                <li>Использует <span class="highlight">response.raise_for_status()</span> для обработки HTTP ошибок</li>
            </ul>
        </div>

        <div class="section">
            <h2>3. Демонстрационный пример (квадратное уравнение)</h2>
            <div class="code-block">
<pre>@logger(handle=sys.stdout)
def solve_quadratic(a: float, b: float, c: float):
    """
    Решает квадратное уравнение вида: ax² + bx + c = 0
    Параметры:
    a, b, c - коэффициенты уравнения
    Возвращает:
    - None: если нет действительных корней
    - float: один корень
    - tuple: два корня
    Исключения:
    TypeError, ValueError - при некорректных входных данных
    """

    if not all(isinstance(coef, (int, float)) for coef in [a, b, c]):
        raise TypeError("Все коэффициенты должны быть числами")

    if a == 0:
        if b == 0:
            if c == 0:
                return None
            else:
                raise ValueError("Уравнение не имеет решений")
        return -c / b

    discriminant = b ** 2 - 4 * a * c

    if discriminant < 0:
        return None
    elif discriminant == 0:
        return -b / (2 * a)
    else:
        sqrt_d = discriminant ** 0.5
        root1 = (-b + sqrt_d) / (2 * a)
        root2 = (-b - sqrt_d) / (2 * a)
        return root1, root2</pre>
            </div>
            <p><span class="highlight">Пример использования (фрагмент вывода):</span></p>
            <div class="logs">
Получение курсов валют:
INFO: 'get_currencies' - успешно
Результат: {'USD': 93.25, 'EUR': 101.7}

Решение квадратных уравнений:
x**2 - 3x + 2 = 0
INFO: 'solve_quadratic' - успешно
Корни: (2.0, 1.0)

x**2 + 2x + 1 = 0
INFO: 'solve_quadratic' - успешно
Корни: -1.0

x**2 + 1 = 0
INFO: 'solve_quadratic' - успешно
Корни: None
            </div>
        </div>

        <div class="section">
            <h2>4. Фрагменты логов</h2>
            <div class="logs">
Получение курсов валют:
INFO: 'get_currencies' - успешно
Результат: {'USD': 93.25, 'EUR': 101.7}

Решение квадратных уравнений:
x**2 - 3x + 2 = 0
INFO: 'solve_quadratic' - успешно
Корни: (2.0, 1.0)

x**2 + 2x + 1 = 0
INFO: 'solve_quadratic' - успешно
Корни: -1.0

x**2 + 1 = 0
INFO: 'solve_quadratic' - успешно
Корни: None

Логирование в файл:
INFO: 'get_usd_rate' - успешно
INFO: 'get_currencies' - успешно
Курс USD записан в currency.log: {'USD': 93.25}

Логирование в StringIO:
INFO: 'multiply' - успешно
Результат: 35
Логи: INFO: 'multiply' - успешно
            </div>
            <p><span class="highlight">Типы логирования:</span></p>
            <ul>
                <li><span class="highlight">INFO</span> - успешное выполнение функций</li>
                <li><span class="highlight">ERROR</span> - ошибки в работе функций</li>
                <li>Логирование в разные потоки: <span class="highlight">sys.stdout</span>, <span class="highlight">io.StringIO</span>, <span class="highlight">logging.Logger</span></li>
            </ul>
        </div>

        <div class="section">
            <h2>5. Тесты</h2>

            <h3>5.1 Тесты функции get_currencies</h3>
            <div class="code-block">
<pre>class TestGetCurrenciesFunction(unittest.TestCase):
    def test_correct_currency_return(self):
        # Проверка корректного возврата курсов валют
        with patch('main.requests.get') as mock_get:
            mock_response = Mock()
            mock_response.status_code = 200
            mock_response.json.return_value = {
                "Valute": {
                    "USD": {"Value": 93.25},
                    "EUR": {"Value": 101.7}
                }
            }
            mock_get.return_value = mock_response

            result = get_currencies(['USD', 'EUR'])
            self.assertEqual(result['USD'], 93.25)
            self.assertEqual(result['EUR'], 101.7)</pre>
            </div>

            <div class="test-results">
                <p><span class="success">Все тесты пройдены успешно:</span></p>
                <ul>
                    <li><span class="success">test_correct_currency_return</span> - проверка корректного возврата курсов</li>
                    <li><span class="success">test_non_exist_currency</span> - поведение при несуществующей валюте</li>
                    <li><span class="success">test_connection_error</span> - выброс ConnectionError</li>
                    <li><span class="success">test_value_error_json</span> - выброс ValueError при некорректном JSON</li>
                    <li><span class="success">test_key_missing_valute</span> - выброс KeyError при отсутствии ключа 'Valute'</li>
                </ul>
            </div>

            <h3>5.2 Тесты декоратора</h3>
            <div class="code-block">
<pre>class TestLoggerDecorator(unittest.TestCase):
    def test_logging(self):
        stream = io.StringIO()

        @logger(handle=stream)
        def test_function(x):
            return x * 2

        result = test_function(5)
        self.assertEqual(result, 10)

        logs = stream.getvalue()
        self.assertIn("INFO", logs)
        self.assertIn("test_function", logs)</pre>
            </div>

            <div class="test-results">
                <p><span class="success">Все тесты пройдены успешно:</span></p>
                <ul>
                    <li><span class="success">test_logging</span> - логирование при успешном выполнении</li>
                    <li><span class="success">test_logging_on_error</span> - логирование при ошибке</li>
                    <li><span class="success">test_logger_different_values</span> - работа с разными типами возвращаемых значений</li>
                </ul>
            </div>

            <h3>5.3 Тесты работы с StringIO</h3>
            <div class="code-block">
<pre>class TestStreamWrite(unittest.TestCase):
    def setUp(self):
        self.stream = io.StringIO()

        @logger(handle=self.stream)
        def wrapped():
            return get_currencies(['USD'], url="https://wrong")

        self.wrapped = wrapped

    def test_logging_error(self):
        with self.assertRaises(ConnectionError):
            self.wrapped()

        logs = self.stream.getvalue()
        self.assertIn("ERROR", logs)
        self.assertIn("ConnectionError", logs)</pre>
            </div>

            <div class="test-results">
                <p><span class="success">Все тесты пройдены успешно:</span></p>
                <ul>
                    <li><span class="success">test_logging_error</span> - логирование ошибок в StringIO</li>
                </ul>
            </div>
        </div>

        <div class="conclusion">
            <h2>6. Выводы и результаты</h2>
            <p><span class="highlight">Основные выводы:</span></p>
            <ul>
                <li><span class="success">Декоратор с параметрами</span> правильно реализован и поддерживает различные типы обработчиков</li>
                <li><span class="success">Функция get_currencies</span> содержит чистую бизнес-логику и корректно выбрасывает исключения</li>
                <li><span class="success">Разделение ответственности</span> соблюдено: бизнес-логика отделена от сквозной функциональности</li>
                <li><span class="success">Тестовое покрытие</span> включает все основные сценарии работы</li>
            </ul>

            <p><span class="highlight">Результаты тестирования:</span></p>
            <ul>
                <li>Все 9 тестов проходят успешно</li>
                <li>Проверены все типы исключений: ConnectionError, ValueError, KeyError, TypeError</li>
                <li>Корректность логирования как при успешном выполнении, так и при ошибках</li>
            </ul>
        </div>
    </div>
</body>
</html>
